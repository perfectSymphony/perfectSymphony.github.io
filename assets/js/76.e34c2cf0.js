(window.webpackJsonp=window.webpackJsonp||[]).push([[76],{432:function(s,t,a){"use strict";a.r(t);var n=a(45),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"vue单页应用刷新网页后vuex的state数据丢失的解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vue单页应用刷新网页后vuex的state数据丢失的解决方案"}},[s._v("#")]),s._v(" vue单页应用刷新网页后vuex的state数据丢失的解决方案")]),s._v(" "),a("h2",{attrs:{id:"产生原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#产生原因"}},[s._v("#")]),s._v(" 产生原因")]),s._v(" "),a("p",[s._v("javascript代码是运行在内存中的，代码运行时的所有变量，函数也都是保存在内存中的。刷新页面，以前申请的内存被释放掉，重新加载脚本代码，变量重新赋值，所以，这些数据要存储就必须存储在外部，如，localStorage，sessionStorage，indexDB等，这些浏览器提供的API，让你可以将数据存储在硬盘上，做持久化存储。")]),s._v(" "),a("p",[s._v("因为store里的数据是保存在运行内存中的,当页面刷新时，页面会重新加载vue实例，store里面的数据就会被重新赋值。")]),s._v(" "),a("h2",{attrs:{id:"解决思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决思路"}},[s._v("#")]),s._v(" 解决思路")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("1、一种是state里的数据全部是通过请求来触发action或mutation来改变")])]),s._v(" "),a("li",[a("p",[s._v("2、一种是将state里的数据保存一份到本地存储(localStorage、sessionStorage、cookie）中")])])]),s._v(" "),a("p",[s._v("很显然，第一种方案基本不可行，除非项目很小或者vuex存储的数据很少。而第二种可以保证刷新页面数据不丢失且易于读取。")]),s._v(" "),a("h2",{attrs:{id:"解决过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决过程"}},[s._v("#")]),s._v(" 解决过程")]),s._v(" "),a("p",[s._v("首先得选择合适的客户端存储")]),s._v(" "),a("p",[a("code",[s._v("localStorage")]),s._v("是永久存储在本地，除非你主动去删除;")]),s._v(" "),a("p",[a("code",[s._v("sessionStorage")]),s._v("是存储到当前页面关闭为止;")]),s._v(" "),a("p",[a("code",[s._v("cookie")]),s._v("则根据你设置的有效时间来存储，但缺点是不能储存大数据且不易读取。")]),s._v(" "),a("p",[s._v("我选择的是"),a("code",[s._v("sessionStorage")]),s._v(",选择的原因vue是单页面应用，操作都是在一个页面跳转路由，另一个原因是"),a("code",[s._v("sessionStorage")]),s._v("可以保证打开页面时"),a("code",[s._v("sessionStorage")]),s._v("的数据为空，而如果是localStorage则会读取上一次打开页面的数据。")]),s._v(" "),a("p",[s._v("然后是怎么用"),a("code",[s._v("sessionStorage")]),s._v("来保存state里的数据。")]),s._v(" "),a("p",[s._v("第一种方案")]),s._v(" "),a("p",[s._v("由于"),a("code",[s._v("state")]),s._v("里的数据是响应式，所以"),a("code",[s._v("sessionStorage")]),s._v("存储也要跟随变化。又由于vuex规定所有state里数据必须通过mutation方法来修改，所以第一种方案就是mutation修改state的同时修改"),a("code",[s._v("sessionStorage")]),s._v("对应存储的属性")]),s._v(" "),a("p",[s._v("第二种方案")]),s._v(" "),a("p",[s._v("第一种方案确实可以解决问题，但这种方法很明显让人觉得怪异，都这样了，那不如直接用"),a("code",[s._v("sessionStorage")]),s._v("来做状态管理。")]),s._v(" "),a("p",[s._v("那怎么才能不用每次修改"),a("code",[s._v("state")]),s._v("时同时也要修改"),a("code",[s._v("sessionStorage")]),s._v("呢？这时我们可以换一个思路，因为我们是只有在刷新页面时才会丢失state里的数据，那有没有办法在点击页面刷新时先将state数据保存到"),a("code",[s._v("sessionStorage")]),s._v(",然后才真正刷新页面?")]),s._v(" "),a("p",[s._v("当然有，"),a("code",[s._v("beforeunload")]),s._v("这个事件在页面刷新时先触发的。那这个事件应该在哪里触发呢？我们总不能每个页面都监听这个事件，所以我选择放在"),a("code",[s._v("app.vue")]),s._v("这个入口组件中，这样就可以保证每次刷新页面都可以触发。")]),s._v(" "),a("h2",{attrs:{id:"具体实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#具体实现"}},[s._v("#")]),s._v(" 具体实现")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" default "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'App'")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("created")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    //在页面加载时读取sessionStorage里的状态信息\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sessionStorage.getItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"store"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        this."),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$store")]),s._v(".replaceState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Object.assign"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(", this."),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$store")]),s._v(".state,JSON.parse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sessionStorage.getItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"store"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n\n    //在页面刷新时将vuex里的信息保存到sessionStorage里\n    window.addEventListener"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"beforeunload"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        sessionStorage.setItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"store"')]),s._v(",JSON.stringify"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("this."),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$store")]),s._v(".state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("应用背景是用户登入后保存状态，退出后移除状态")]),s._v(" "),a("p",[s._v("mutations.js")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("ADD_LOGIN_USER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state,data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  //登入，保存状态\n  sessionStorage.setItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),s._v(", data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  //添加到sessionStorage\n  sessionStorage.setItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isLogin"')]),s._v(",true"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  state.username"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("data,             //同步的改变store中的状态\n  state.isLogin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\nSIGN_OUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   //退出，删除状态\n  sessionStorage.removeItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  //移除sessionStorage\n  sessionStorage.removeItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isLogin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  state.username"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("                //同步的改变story中的状态\n  state.isLogin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("getters.js")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("isLogin "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("state.isLogin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n      state.isLogin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sessionStorage.getItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isLogin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   //从sessionStorage中读取状态\n      state.username"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sessionStorage.getItem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'username'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" state.username\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);